// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Unit {
  id        Int      @id @default(autoincrement())
  name      String
  code      String?  @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  accessRules UnitAccessRule[] 
}

model UnitAccessRule {
  id        Int      @id @default(autoincrement())
  unitId    Int
  page      String
  tab       String?  // null یعنی کل تب‌های اون صفحه
  permitted Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@unique([unitId, page, tab])
}

model CurrencyType {
  id        Int      @id @default(autoincrement())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CurrencySource {
  id        Int      @id @default(autoincrement())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id        Int      @id @default(autoincrement())
  label     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id   Int    @id @default(autoincrement())
  code String @db.VarChar(20)
  name String @db.VarChar(255)

  @@map("projects") // جدول واقعی در Postgres
}

model User {
  id         Int           @id @default(autoincrement())
  name       String?
  email      String?       @unique
  username   String        @unique
  password   String
  department String?
  role       String        @default("user")
  // همون access / access_labels
  access     String[]      @default([])
  // ارتباط با نقش‌ها
  roles      UserRoleMap[]
  sessions   Session[]
}

model UserRole {
  id    Int           @id @default(autoincrement())
  name  String        @unique
  users UserRoleMap[]
}

model UserRoleMap {
  userId Int
  roleId Int

  user User     @relation(fields: [userId], references: [id])
  role UserRole @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Center {
  id          Int      @id @default(autoincrement())
  kind        String   @db.Text
  suffix      String   @db.Text
  description String   @default("") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([kind, suffix])
  @@index([kind])
  @@map("centers")
}

model Session {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
}

model RevenueEstimateRow {
  id          Int     @id @default(autoincrement())
  code        String
  rowIndex    Int     @map("row_index")
  title       String
  description String? @default("")
  projectId   Int?    @map("project_id")
  monthsJson  Json    @map("months_json")
  amount      BigInt  @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([rowIndex])
  @@map("revenue_estimate_rows")
}

model BudgetEstimate {
  id          BigInt   @id @default(autoincrement())
  kind        String
  projectId   BigInt?  @map("project_id")
  code        String
  amount      BigInt   @default(0)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([kind, projectId, code, createdAt(sort: Desc)])
  @@map("budget_estimates")
}