// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentRequestStatus {
  pending
  approved
  rejected
  returned
}

model Unit {
  id        Int      @id @default(autoincrement())
  name      String
  code      String?  @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accessRules UnitAccessRule[]
  users       UserUnit[]
}

model UnitAccessRule {
  id        Int     @id @default(autoincrement())
  unitId    Int
  page      String
  tab       String? // null یعنی کل تب‌های اون صفحه
  permitted Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@unique([unitId, page, tab])
}

model CurrencyType {
  id        Int      @id @default(autoincrement())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentRequests PaymentRequest[]
}

model CurrencySource {
  id        Int      @id @default(autoincrement())
  title     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  paymentRequests PaymentRequest[]
}

model Tag {
  id         Int      @id @default(autoincrement())
  scope      String   // same as category scope
  label      String
  categoryId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  category TagCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, label])
  @@index([scope])
  @@index([categoryId])
}

model TagCategory {
  id        Int      @id @default(autoincrement())
  scope     String   // letters | execution | ...
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tags Tag[]

  // opposite relation for Letter.classification
  lettersClassified Letter[] @relation("LetterClassification")

  @@unique([scope, label])
  @@index([scope])
}

model Project {
  id   Int    @id @default(autoincrement())
  code String @db.VarChar(20)
  name String @db.VarChar(255)

  @@map("projects")
}

model User {
  id         Int      @id @default(autoincrement())
  name       String?
  email      String?  @unique
  username   String   @unique
  password   String
  department String?
  role       String   @default("user")

  // همون access / access_labels
  access   String[]      @default([])
  roles    UserRoleMap[]
  sessions Session[]
  units    UserUnit[]

  // Payment Requests relations
  createdPaymentRequests  PaymentRequest[] @relation("PR_CreatedBy")
  assignedPaymentRequests PaymentRequest[] @relation("PR_AssignedTo")
  uploadedPaymentDocs     PaymentDoc[]     @relation("PRDoc_UploadedBy")

  // opposite relation for UserLetterPrefs.user
  letterPrefs UserLetterPrefs? @relation("UserLetterPrefsUser")
}

model UserRole {
  id    Int           @id @default(autoincrement())
  name  String        @unique
  users UserRoleMap[]
}

model UserRoleMap {
  userId Int
  roleId Int

  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role UserRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Center {
  id          Int      @id @default(autoincrement())
  kind        String   @db.Text
  suffix      String   @db.Text
  description String   @default("") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([kind, suffix])
  @@index([kind])
  @@map("centers")
}

model Session {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
}

model RevenueEstimateRow {
  id          Int     @id @default(autoincrement())
  code        String
  rowIndex    Int     @map("row_index")
  title       String
  description String? @default("")
  projectId   Int?    @map("project_id")
  monthsJson  Json    @map("months_json")
  amount      BigInt  @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@index([rowIndex])
  @@map("revenue_estimate_rows")
}

model BudgetEstimate {
  id          BigInt   @id @default(autoincrement())
  kind        String
  projectId   BigInt?  @map("project_id")
  code        String
  amount      BigInt   @default(0)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([kind, projectId, code, createdAt(sort: Desc)])
  @@map("budget_estimates")
}

model UserUnit {
  userId Int
  unitId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@id([userId, unitId])
  @@index([unitId])
}

model Letter {
  id Int @id @default(autoincrement())

  kind String

  // کلاس سند
  docClass String? @map("doc_class")

  // طبقه‌بندی (Category از جدول TagCategory)
  classificationId Int? @map("classification_id")
  classification   TagCategory? @relation("LetterClassification", fields: [classificationId], references: [id], onDelete: SetNull)

  category  String?
  projectId Int?

  letterNo   String?
  letterDate String?

  fromName String?
  toName   String?
  orgName  String?
  subject  String?

  hasAttachment   Boolean @default(false)
  attachmentTitle String?

  returnToIds Json?
  piroIds     Json?
  tagIds      Json?

  secretariatDate String?
  secretariatNo   String?
  receiverName    String?
  secretariatNote String? @map("secretariat_note")

  attachments Json?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([kind])
  @@index([projectId])
  @@index([createdAt])
  @@index([classificationId])
}

model UserLetterPrefs {
  userId Int @id
  user   User @relation("UserLetterPrefsUser", fields: [userId], references: [id], onDelete: Cascade)

  // برای هر تب جدا (وارده/صادره/داخلی/همه)
  allTagIds      Json? @map("all_tag_ids")
  incomingTagIds Json? @map("incoming_tag_ids")
  outgoingTagIds Json? @map("outgoing_tag_ids")
  internalTagIds Json? @map("internal_tag_ids")

  // اگر طبقه‌بندی (Category) هم در فیلتر دارید و می‌خواید ذخیره بشه
  allClassificationId      Int? @map("all_classification_id")
  incomingClassificationId Int? @map("incoming_classification_id")
  outgoingClassificationId Int? @map("outgoing_classification_id")
  internalClassificationId Int? @map("internal_classification_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([updatedAt])
  @@map("user_letter_prefs")
}

model UploadedFile {
  id           Int      @id @default(autoincrement())
  sha256       String   @unique
  originalName String
  storedName   String
  mimeType     String?
  size         Int
  url          String
  createdBy    Int?
  createdAt    DateTime @default(now())

  @@index([createdAt])
}

model PaymentDoc {
  id           String   @id @default(cuid())
  originalName String
  storedName   String
  mimeType     String
  size         Int
  url          String
  createdAt    DateTime @default(now())

  uploadedById Int?
  uploadedBy   User? @relation("PRDoc_UploadedBy", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([createdAt])
}

model PaymentRequest {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== UI fields =====
  serial      String?
  dateJalali  String?
  scope       String // office/site/finance/cash/capex/projects
  title       String
  description String?

  amount         BigInt
  cashAmount     BigInt?
  cashDateJalali String?

  creditAmount BigInt?
  creditPay    String?

  beneficiaryName String?
  bankInfo        String?

  // ===== doc section =====
  docId         String?
  docOther      String?
  docNumber     String?
  docDateJalali String?

  // ===== currency =====
  currencyTypeId   Int?
  currencyType     CurrencyType? @relation(fields: [currencyTypeId], references: [id], onDelete: SetNull)
  currencySourceId Int?
  currencySource   CurrencySource? @relation(fields: [currencySourceId], references: [id], onDelete: SetNull)

  // ===== optional links =====
  projectId  Int?
  budgetCode String?

  // ===== workflow/action =====
  status      PaymentRequestStatus @default(pending)
  historyJson Json?
  attachments Json?

  // ===== ownership/assignment =====
  createdById Int
  createdBy   User @relation("PR_CreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  currentAssigneeUserId Int?
  currentAssigneeUser   User? @relation("PR_AssignedTo", fields: [currentAssigneeUserId], references: [id], onDelete: SetNull)

  @@index([scope])
  @@index([status])
  @@index([createdById])
  @@index([currentAssigneeUserId])
}
